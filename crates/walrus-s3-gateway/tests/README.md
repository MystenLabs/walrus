# Walrus S3 Gateway Test Script

This comprehensive test script validates the Walrus S3 Gateway with client-side signing functionality.

## Features

- ‚úÖ **Environment Variable Configuration**: All settings configurable via environment variables
- ‚úÖ **Sui Wallet Management**: Automatic wallet creation and funding
- ‚úÖ **Comprehensive Testing**: Tests all S3 gateway endpoints
- ‚úÖ **Client-Side Signing**: Tests transaction generation and submission workflow
- ‚úÖ **Flexible Configuration**: Support for different networks and environments
- ‚úÖ **Auto-cleanup**: Automatic cleanup of temporary resources

## Quick Start

```bash
# Run with default configuration
./test-complete.sh

# Show current configuration
./test-complete.sh --show-config

# Show help
./test-complete.sh --help
```

## Configuration

### Environment Variables

You can customize the test behavior using environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `GATEWAY_PROTOCOL` | `http` | Gateway protocol (http/https) |
| `GATEWAY_HOST` | `127.0.0.1` | Gateway host |
| `GATEWAY_PORT` | `8080` | Gateway port |
| `GATEWAY_URL` | *computed* | Gateway URL (auto-composed from protocol://host:port) |
| `ACCESS_KEY` | `walrus-access-key` | S3 access key |
| `SECRET_KEY` | `walrus-secret-key` | S3 secret key |
| `AWS_REGION` | `us-east-1` | AWS region |
| `SUI_NETWORK` | `testnet` | Sui network (testnet/devnet/mainnet) |
| `SUI_RPC_URL` | `https://fullnode.testnet.sui.io:443` | Sui RPC URL |
| `TEST_BUCKET` | `test-bucket-<timestamp>` | Test bucket name |
| `TEST_OBJECT` | `test-object.txt` | Test object name |
| `REQUEST_TIMEOUT` | `30` | Request timeout (seconds) |
| `FAUCET_TIMEOUT` | `30` | Faucet timeout (seconds) |
| `FAUCET_WAIT_TIME` | `10` | Wait time after faucet (seconds) |
| `AUTO_CLEANUP` | `true` | Auto cleanup temporary files |

### Using Environment Variables

#### Option 1: Inline Variables
```bash
GATEWAY_HOST=localhost GATEWAY_PORT=9000 ./test-complete.sh
```

#### Option 2: Export Variables
```bash
export GATEWAY_PROTOCOL=https
export GATEWAY_HOST=my-gateway.com
export GATEWAY_PORT=443
./test-complete.sh
```

#### Option 3: .env File
```bash
# Copy the example file
cp .env.example .env

# Edit .env with your configuration
nano .env

# Run the test (automatically loads .env)
./test-complete.sh
```

## Automatic Cleanup

The script automatically cleans up temporary files created during execution:

- **Temporary wallet directory**: Created in `/tmp` and removed after use
- **Key files**: `.key` files generated by Sui CLI are automatically removed
- **Test content files**: Temporary test files are cleaned up

### Cleanup Configuration

You can control the cleanup behavior:

```bash
# Disable automatic cleanup (for debugging)
AUTO_CLEANUP=false ./test-complete.sh

# Enable cleanup (default)
AUTO_CLEANUP=true ./test-complete.sh
```

**Note**: When `AUTO_CLEANUP=false`, you may need to manually remove `.key` files and other temporary files after testing.

## Prerequisites

- **Sui CLI**: Install from https://docs.sui.io/build/install
- **curl**: For HTTP requests
- **jq**: For JSON parsing (optional, but recommended)

## Running Different Scenarios

### Local Development
```bash
GATEWAY_HOST=localhost GATEWAY_PORT=9000 ./test-complete.sh
```

### HTTPS Gateway
```bash
GATEWAY_PROTOCOL=https GATEWAY_HOST=my-gateway.com GATEWAY_PORT=443 ./test-complete.sh
```

### Devnet Testing
```bash
SUI_NETWORK=devnet SUI_RPC_URL=https://fullnode.devnet.sui.io:443 ./test-complete.sh
```

### Custom Gateway Configuration
```bash
GATEWAY_HOST=my-gateway.com GATEWAY_PORT=8443 ACCESS_KEY=my-key ./test-complete.sh
```

### Fast Testing (Reduced Timeouts)
```bash
FAUCET_TIMEOUT=10 FAUCET_WAIT_TIME=5 ./test-complete.sh
```

## Test Output

The script provides detailed output including:

- ‚úÖ Configuration summary
- üîê Sui wallet creation and funding
- üîó Gateway connectivity verification
- üì§ PUT object with client-side signing
- üîß Transaction template generation
- üìù Signed transaction submission
- üì• GET object testing
- üóëÔ∏è DELETE object testing

## Expected Results

The test validates that:

1. **Gateway is accessible** and responds to requests
2. **PUT operations** return appropriate client signing requirements
3. **Transaction endpoints** respond with correct formats
4. **S3 operations** follow proper authentication protocols

## Troubleshooting

### Gateway Not Accessible
Ensure the gateway is running:
```bash
cargo run --bin walrus-s3-gateway
```

### Authentication Errors
Verify your access key matches the gateway configuration:
```bash
ACCESS_KEY=your-actual-key ./test-complete.sh
```

### Network Issues
Try different timeout values:
```bash
REQUEST_TIMEOUT=60 FAUCET_TIMEOUT=60 ./test-complete.sh
```

## Development

The script is modular and extensible. Key functions:

- `setup_sui_wallet()`: Creates and funds Sui wallet
- `check_gateway_status()`: Verifies gateway accessibility
- `test_*()`: Individual test functions for each endpoint
- `print_configuration()`: Shows current configuration

## License

This test script is part of the Walrus project and follows the same licensing terms.
