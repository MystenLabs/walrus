name: Generate Sui Version Upgrade PR
run-name: Generate Sui Version Upgrade PR

on:
  workflow_dispatch:
    inputs:
      new_tag:
        description: "New Sui tag (e.g., testnet-v1.55.0), if empty defaults to current"
        required: false
        type: string

  repository_dispatch:
    types: [update-walrus-sui-testnet-tag]

concurrency: ${{ github.workflow }}-${{ inputs.new_tag }}

permissions:
  contents: write
  pull-requests: write

env:
  NEW_TAG: ${{ github.event.client_payload.new_tag || inputs.new_tag || '' }}
  CARGO_TERM_COLOR: always
  # Disable incremental compilation.
  #
  # Incremental compilation is useful as part of an edit-build-test-edit cycle,
  # as it lets the compiler avoid recompiling code that hasn't changed. However,
  # on CI, we're not making small edits; we're almost always building the entire
  # project from scratch. Thus, incremental compilation on CI actually
  # introduces *additional* overhead to support making future builds
  # faster...but no future builds will ever occur in any given CI environment.
  #
  # See https://matklad.github.io/2021/09/04/fast-rust-builds.html#ci-workflow
  # for details.
  CARGO_INCREMENTAL: 0
  # Allow more retries for network requests in cargo (downloading crates) and
  # rustup (installing toolchains). This should help to reduce flaky CI failures
  # from transient network timeouts or other issues.
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10
  # Don't emit giant backtraces in the CI logs.
  RUST_BACKTRACE: short

jobs:
  bump:
    name: Bump Sui Testnet Version
    runs-on: ubuntu-ghcloud
    outputs:
      pr_url: ${{ steps.generate_pr.outputs.pr_url || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # pin@v6.0.2

      - name: Get testnet version, if not provided
        if: ${{ env.NEW_TAG == '' }}
        run: |
          echo "No new tag provided, using current Sui testnet version."
          CURRENT_TAG=$(curl -s https://api.github.com/repos/MystenLabs/sui/releases \
            | jq -r '[.[] | select(.tag_name | startswith("testnet-")) | .tag_name] | first')
          echo "Current Sui testnet version is: $CURRENT_TAG"
          echo "NEW_TAG=$CURRENT_TAG" >> $GITHUB_ENV

      - name: Install ${{ env.NEW_TAG }} sui binary for move builds
        shell: bash
        run: |
          curl -sSfL https://raw.githubusercontent.com/Mystenlabs/suiup/main/install.sh | sh
          suiup install sui@${{ env.NEW_TAG }} -y

      - name: Generate PR for ${{ env.NEW_TAG }}
        id: generate_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        shell: bash
        run: |
          export PR_URL=$(./scripts/bump_sui_testnet_version.sh "${{ env.NEW_TAG }}" | tail -1)
          echo "PR_URL=${PR_URL}" >> "$GITHUB_OUTPUT"

  notify:
    needs: bump
    name: Notify oncall via sui-operations
    runs-on: ubuntu-latest
    if: success() && needs.bump.outputs.pr_url != ''

    steps:
      - name: Dispatch notification to sui-operations
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # pin@v3.0.0
        with:
          token: ${{ secrets.SUI_OPERATIONS_DISPATCH_TOKEN }}
          repository: MystenLabs/sui-operations
          event-type: walrus-sui-upgrade-notify
          client-payload: |-
            {
              "pr_url": "${{ needs.bump.outputs.pr_url }}",
              "new_tag": "${{ env.NEW_TAG }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "run_id": "${{ github.run_id }}"
            }
