name: Generate Sui Version Upgrade PR
run-name: Generate Sui Version Upgrade PR

on:
  workflow_dispatch:
    inputs:
      new_sui_tag:
        description: "New Sui tag (e.g., testnet-v1.55.0), if empty will default to current sui testnet version"
        required: false
        type: string
      bump_walrus_version:
        description: "Create Walrus version bump PR"
        required: false
        type: boolean
        default: false

  repository_dispatch:
    types: [update-walrus-sui-testnet-tag]

concurrency: ${{ github.workflow }}-${{ inputs.new_sui_tag }}

permissions:
  contents: write
  pull-requests: write

env:
  NEW_SUI_TAG: ${{ github.event.client_payload.new_tag || inputs.new_sui_tag || '' }}

jobs:
  bump-sui-testnet-version:
    name: Bump Sui Testnet Version
    runs-on: ubuntu-ghcloud

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # pin@v4

      - name: Get testnet version, if not provided
        if: ${{ env.NEW_SUI_TAG == '' }}
        run: |
          echo "No new tag provided, using current Sui testnet version."
          CURRENT_SUI_TAG=$(curl -s https://api.github.com/repos/MystenLabs/sui/releases \
            | jq -r '[.[] | select(.tag_name | startswith("testnet-")) | .tag_name] | first')
          echo "Current Sui testnet version is: $CURRENT_SUI_TAG"
          echo "NEW_SUI_TAG=$CURRENT_SUI_TAG" >> $GITHUB_ENV

      - name: Install ${{ env.NEW_SUI_TAG }} sui binary for move builds
        shell: bash
        run: |
          curl -sSfL https://raw.githubusercontent.com/Mystenlabs/suiup/main/install.sh | sh
          suiup install sui@${{ env.NEW_SUI_TAG }} -y

      - name: Generate PR for ${{ env.NEW_SUI_TAG }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        shell: bash
        run: |
          ./scripts/bump_sui_testnet_version.sh "${{ env.NEW_SUI_TAG }}"

  bump-walrus-version:
    name: Bump Walrus Version
    if: ${{ inputs.bump_walrus_version }}
    runs-on: ubuntu-ghcloud

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # pin@v4

      - name: Generate Walrus Version Bump PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        shell: bash
        run: |
          ./scripts/bump_walrus_version.sh
